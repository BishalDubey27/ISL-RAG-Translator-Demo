<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Sign Recognition - ISL Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .camera-container {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            min-height: 400px;
        }
        
        #camera-feed {
            width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: 12px;
        }
        
        #camera-placeholder {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
        }
        
        .recording-indicator {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        
        .recording-indicator.hidden {
            display: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .control-btn {
            transition: all 0.3s ease;
            transform: scale(1);
        }
        
        .control-btn:hover {
            transform: scale(1.05);
        }
        
        .control-btn:active {
            transform: scale(0.95);
        }
        
        .result-card {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .confidence-bar {
            transition: width 0.8s ease;
        }
        
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #4ade80;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-ready { background-color: #10b981; }
        .status-recording { background-color: #ef4444; animation: pulse 1s infinite; }
        .status-processing { background-color: #f59e0b; animation: pulse 1s infinite; }
        .status-error { background-color: #ef4444; }
        
        .gesture-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .hand-landmark {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            border: 2px solid white;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="glass rounded-2xl p-6 mb-6 text-white">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 class="text-3xl font-bold mb-2">üìπ Live Sign Recognition</h1>
                    <p class="text-white/80">Real-time sign language recognition using your camera</p>
                </div>
                <div class="mt-4 md:mt-0 flex gap-3">
                    <a href="/" class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 transition">
                        ‚Üê Text to Sign
                    </a>
                    <a href="/sign-recognition" class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 transition">
                        üì§ Upload Video
                    </a>
                </div>
            </div>
            
            <!-- System Status -->
            <div class="mt-4 flex items-center gap-6 text-sm">
                <div class="flex items-center">
                    <span id="status-indicator" class="status-indicator status-ready"></span>
                    <span id="status-text">Ready</span>
                </div>
                <div class="flex items-center gap-4">
                    <span id="camera-status" class="text-white/70">Camera: Checking...</span>
                    <span id="model-status" class="text-white/70">Model: Loading...</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Video Feed Section -->
            <div>
                <div class="glass rounded-2xl p-6">
                    <h2 class="text-2xl font-bold text-white mb-4">üì∑ Camera Feed</h2>
                    <div class="camera-container mb-4 relative">
                        <video id="camera-feed" autoplay muted playsinline style="display: none;">
                            Your browser doesn't support video.
                        </video>
                        
                        <!-- Recording Indicator -->
                        <div id="recording-indicator" class="recording-indicator hidden">
                            üî¥ RECORDING
                        </div>
                        
                        <!-- Hand Landmarks Overlay -->
                        <div id="gesture-overlay" class="gesture-overlay"></div>
                        
                        <!-- Camera Placeholder -->
                        <div id="camera-placeholder" class="absolute inset-0 flex items-center justify-center text-white">
                            <div class="text-center">
                                <div class="text-6xl mb-4">üì∑</div>
                                <h3 class="text-xl font-bold mb-2">Camera Access Required</h3>
                                <p class="text-white/70 mb-4">Please allow camera access to start sign recognition</p>
                                
                                <!-- Camera Selection -->
                                <select id="camera-select" class="mb-4 px-4 py-2 rounded-lg bg-white/20 text-white border border-white/30">
                                    <option value="">Select Camera...</option>
                                </select>
                                
                                <button id="start-camera-btn" class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold transition">
                                    üé• Start Camera
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Camera Controls -->
                    <div class="flex flex-wrap gap-3 mb-4">
                        <button id="capture-btn" class="control-btn flex-1 px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition disabled:opacity-50" disabled>
                            üì∏ Capture Sign
                        </button>
                        <button id="record-btn" class="control-btn flex-1 px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold transition disabled:opacity-50" disabled>
                            üé¨ Record (3s)
                        </button>
                        <button id="continuous-btn" class="control-btn px-4 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-semibold transition disabled:opacity-50" disabled>
                            üîÑ Continuous
                        </button>
                    </div>
                    
                    <!-- Instructions -->
                    <div class="glass rounded-lg p-4">
                        <h3 class="font-semibold text-white mb-2">üìã Instructions</h3>
                        <ul class="text-sm text-white/80 space-y-1">
                            <li>‚Ä¢ Position yourself clearly in front of the camera</li>
                            <li>‚Ä¢ Ensure good lighting for better recognition</li>
                            <li>‚Ä¢ Perform signs slowly and clearly</li>
                            <li>‚Ä¢ Use "Capture" for single frame or "Record" for motion</li>
                            <li>‚Ä¢ "Continuous" mode provides real-time recognition</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div>
                <div class="glass rounded-2xl p-6">
                    <h2 class="text-2xl font-bold text-white mb-4">üéØ Recognition Results</h2>
                    
                    <!-- Welcome State -->
                    <div id="welcome-state" class="text-center text-white py-8">
                        <div class="text-6xl mb-4">üëã</div>
                        <h3 class="text-xl font-bold mb-2">Ready to Recognize Signs</h3>
                        <p class="text-white/70">Start your camera and perform a sign to begin</p>
                    </div>
                    
                    <!-- Processing State -->
                    <div id="processing-state" class="hidden text-center text-white py-8">
                        <div class="loader mx-auto mb-4"></div>
                        <h3 class="text-xl font-bold mb-2">Processing...</h3>
                        <p class="text-white/70">Analyzing sign language</p>
                    </div>
                    
                    <!-- Results Display -->
                    <div id="results-display" class="hidden result-card">
                        <div class="glass rounded-lg p-6 mb-4">
                            <div class="text-center mb-4">
                                <div class="text-5xl mb-2">‚úÖ</div>
                                <h3 class="text-3xl font-bold text-white mb-2" id="recognized-sign">-</h3>
                                <p class="text-white/70 text-sm" id="timestamp">-</p>
                            </div>
                            
                            <!-- Confidence Bar -->
                            <div class="mb-4">
                                <div class="flex justify-between text-sm text-white/70 mb-1">
                                    <span>Confidence</span>
                                    <span id="confidence-percent">0%</span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-3 overflow-hidden">
                                    <div id="confidence-bar" class="confidence-bar bg-green-500 h-full rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <!-- Stats -->
                            <div class="grid grid-cols-2 gap-3 mb-4 text-sm">
                                <div class="glass rounded-lg p-3 text-center">
                                    <div class="text-white/70">Processing Time</div>
                                    <div class="text-white font-semibold" id="processing-time">-</div>
                                </div>
                                <div class="glass rounded-lg p-3 text-center">
                                    <div class="text-white/70">Frames</div>
                                    <div class="text-white font-semibold" id="frame-count">-</div>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex gap-2">
                                <button id="play-result-audio" class="flex-1 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition disabled:opacity-50">
                                    üîä Play Audio
                                </button>
                                <button id="copy-result" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition">
                                    üìã Copy Text
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Error State -->
                    <div id="error-state" class="hidden text-center text-white py-8">
                        <div class="text-5xl mb-4">‚ùå</div>
                        <h3 class="text-xl font-bold mb-2">Recognition Failed</h3>
                        <p class="text-white/70" id="error-message">An error occurred</p>
                    </div>
                    
                    <!-- Recognition History -->
                    <div class="mt-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-white">üìú History</h3>
                            <button id="clear-history" class="text-xs px-3 py-1 bg-white/20 hover:bg-white/30 text-white rounded transition">
                                Clear
                            </button>
                        </div>
                        <div id="recognition-history" class="space-y-2 max-h-64 overflow-y-auto">
                            <div class="text-center text-white/50 py-4 text-sm">No recognition history yet</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Elements -->
    <canvas id="capture-canvas" style="display: none;"></canvas>
    <audio id="result-audio" style="display: none;"></audio>

    <script>
        // Global variables
        let stream = null;
        let isRecording = false;
        let isContinuous = false;
        let recognitionHistory = [];
        let currentAudioUrl = null;
        
        // DOM elements
        const cameraFeed = document.getElementById('camera-feed');
        const cameraPlaceholder = document.getElementById('camera-placeholder');
        const startCameraBtn = document.getElementById('start-camera-btn');
        const cameraSelect = document.getElementById('camera-select');
        const captureBtn = document.getElementById('capture-btn');
        const recordBtn = document.getElementById('record-btn');
        const continuousBtn = document.getElementById('continuous-btn');
        const recordingIndicator = document.getElementById('recording-indicator');
        
        // Status elements
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const cameraStatus = document.getElementById('camera-status');
        const modelStatus = document.getElementById('model-status');
        
        // Result elements
        const welcomeState = document.getElementById('welcome-state');
        const processingState = document.getElementById('processing-state');
        const resultsDisplay = document.getElementById('results-display');
        const errorState = document.getElementById('error-state');
        const recognizedSign = document.getElementById('recognized-sign');
        const confidencePercent = document.getElementById('confidence-percent');
        const confidenceBar = document.getElementById('confidence-bar');
        const timestamp = document.getElementById('timestamp');
        const playResultAudio = document.getElementById('play-result-audio');
        const copyResult = document.getElementById('copy-result');
        const processingTime = document.getElementById('processing-time');
        const frameCount = document.getElementById('frame-count');
        const recognitionHistoryEl = document.getElementById('recognition-history');
        const clearHistory = document.getElementById('clear-history');
        const resultAudio = document.getElementById('result-audio');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemStatus();
            setupEventListeners();
            loadCameraDevices();
        });
        
        function setupEventListeners() {
            startCameraBtn.addEventListener('click', startCamera);
            captureBtn.addEventListener('click', captureSign);
            recordBtn.addEventListener('click', toggleRecording);
            continuousBtn.addEventListener('click', toggleContinuous);
            playResultAudio.addEventListener('click', playAudio);
            copyResult.addEventListener('click', copyToClipboard);
            clearHistory.addEventListener('click', clearRecognitionHistory);
            cameraSelect.addEventListener('change', switchCamera);
        }
        
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/sign-recognition-status');
                const status = await response.json();
                
                if (status.model_loaded) {
                    modelStatus.textContent = 'Model: ‚úÖ Ready';
                } else {
                    modelStatus.textContent = 'Model: üé≠ Demo Mode';
                }
            } catch (error) {
                modelStatus.textContent = 'Model: ‚ùå Error';
            }
        }
        
        async function loadCameraDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                cameraSelect.innerHTML = '<option value="">Select Camera...</option>';
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `Camera ${index + 1}`;
                    cameraSelect.appendChild(option);
                });
                
                if (videoDevices.length > 0) {
                    cameraSelect.value = videoDevices[0].deviceId;
                }
            } catch (error) {
                console.error('Error loading camera devices:', error);
            }
        }
        
        async function startCamera() {
            try {
                updateStatus('processing', 'Starting camera...');
                
                const constraints = {
                    video: {
                        deviceId: cameraSelect.value ? { exact: cameraSelect.value } : undefined,
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 30 }
                    },
                    audio: false
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraFeed.srcObject = stream;
                
                // Hide placeholder, show feed
                cameraPlaceholder.style.display = 'none';
                cameraFeed.style.display = 'block';
                
                // Enable controls
                captureBtn.disabled = false;
                recordBtn.disabled = false;
                continuousBtn.disabled = false;
                
                updateStatus('ready', 'Camera ready');
                cameraStatus.textContent = 'Camera: ‚úÖ Active';
                
            } catch (error) {
                console.error('Camera access error:', error);
                updateStatus('error', 'Camera access denied');
                cameraStatus.textContent = 'Camera: ‚ùå Access denied';
                showError('Camera access denied. Please allow camera permissions and try again.');
            }
        }
        
        async function switchCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                await startCamera();
            }
        }
        
        async function captureSign() {
            if (!stream) return;
            
            showProcessing();
            const startTime = Date.now();
            
            try {
                // Capture frame from video
                const canvas = document.getElementById('capture-canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = cameraFeed.videoWidth;
                canvas.height = cameraFeed.videoHeight;
                ctx.drawImage(cameraFeed, 0, 0);
                
                // Convert to blob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
                
                // Send for recognition
                const formData = new FormData();
                formData.append('image', blob, 'capture.jpg');
                
                const response = await fetch('/recognize-live-sign', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                const processingTimeMs = Date.now() - startTime;
                
                if (result.success) {
                    showResult(result, processingTimeMs, 1);
                    addToHistory(result, 'Capture');
                } else {
                    showError(result.error || 'Recognition failed');
                }
                
            } catch (error) {
                console.error('Capture error:', error);
                showError('Failed to capture and recognize sign');
            }
        }
        
        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }
        
        function startRecording() {
            if (!stream) return;
            
            isRecording = true;
            recordBtn.textContent = '‚èπÔ∏è Stop Recording';
            recordBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            recordBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
            recordingIndicator.classList.remove('hidden');
            updateStatus('recording', 'Recording...');
            
            // Auto-stop after 3 seconds
            setTimeout(() => {
                if (isRecording) {
                    stopRecording();
                }
            }, 3000);
        }
        
        function stopRecording() {
            isRecording = false;
            recordBtn.textContent = 'üé¨ Record (3s)';
            recordBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            recordingIndicator.classList.add('hidden');
            updateStatus('processing', 'Processing recording...');
            
            // Simulate processing recorded video
            setTimeout(() => {
                processRecordedVideo();
            }, 1000);
        }
        
        async function processRecordedVideo() {
            showProcessing();
            const startTime = Date.now();
            
            try {
                // Simulate video processing
                const response = await fetch('/recognize-live-sign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'video_recording' })
                });
                
                const result = await response.json();
                const processingTimeMs = Date.now() - startTime;
                
                if (result.success) {
                    showResult(result, processingTimeMs, 90); // Assume 90 frames for 3s video
                    addToHistory(result, 'Recording');
                } else {
                    showError(result.error || 'Recording recognition failed');
                }
                
            } catch (error) {
                console.error('Recording processing error:', error);
                showError('Failed to process recorded video');
            }
        }
        
        function toggleContinuous() {
            isContinuous = !isContinuous;
            
            if (isContinuous) {
                continuousBtn.textContent = '‚è∏Ô∏è Stop Continuous';
                continuousBtn.classList.remove('bg-purple-500', 'hover:bg-purple-600');
                continuousBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
                updateStatus('recording', 'Continuous recognition active');
                startContinuousRecognition();
            } else {
                continuousBtn.textContent = 'üîÑ Continuous';
                continuousBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                continuousBtn.classList.add('bg-purple-500', 'hover:bg-purple-600');
                updateStatus('ready', 'Continuous recognition stopped');
                stopContinuousRecognition();
            }
        }
        
        function startContinuousRecognition() {
            // Continuous recognition every 2 seconds
            if (isContinuous) {
                captureSign();
                setTimeout(startContinuousRecognition, 2000);
            }
        }
        
        function stopContinuousRecognition() {
            isContinuous = false;
        }
        
        function showProcessing() {
            welcomeState.classList.add('hidden');
            resultsDisplay.classList.add('hidden');
            errorState.classList.add('hidden');
            processingState.classList.remove('hidden');
        }
        
        function showResult(result, processingTimeMs, frames) {
            // Update result display
            recognizedSign.textContent = result.recognized_text;
            confidencePercent.textContent = `${(result.confidence * 100).toFixed(1)}%`;
            confidenceBar.style.width = `${result.confidence * 100}%`;
            timestamp.textContent = new Date().toLocaleTimeString();
            processingTime.textContent = `${processingTimeMs}ms`;
            frameCount.textContent = frames;
            
            // Handle audio
            if (result.audio_url) {
                resultAudio.src = result.audio_url;
                playResultAudio.disabled = false;
                currentAudioUrl = result.audio_url;
            } else {
                playResultAudio.disabled = true;
                currentAudioUrl = null;
            }
            
            // Show results
            welcomeState.classList.add('hidden');
            processingState.classList.add('hidden');
            errorState.classList.add('hidden');
            resultsDisplay.classList.remove('hidden');
            
            updateStatus('ready', 'Recognition complete');
        }
        
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            
            welcomeState.classList.add('hidden');
            processingState.classList.add('hidden');
            resultsDisplay.classList.add('hidden');
            errorState.classList.remove('hidden');
            
            updateStatus('error', 'Recognition failed');
        }
        
        function addToHistory(result, method) {
            const historyItem = {
                text: result.recognized_text,
                confidence: result.confidence,
                timestamp: new Date().toLocaleTimeString(),
                method: method
            };
            
            recognitionHistory.unshift(historyItem);
            if (recognitionHistory.length > 10) {
                recognitionHistory.pop();
            }
            
            updateHistoryDisplay();
        }
        
        function updateHistoryDisplay() {
            if (recognitionHistory.length === 0) {
                recognitionHistoryEl.innerHTML = '<div class="text-center text-white/50 py-4 text-sm">No recognition history yet</div>';
                return;
            }
            
            recognitionHistoryEl.innerHTML = recognitionHistory.map(item => `
                <div class="glass rounded-lg p-3">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-semibold text-white text-sm">${item.text}</span>
                        <span class="text-xs text-white/60">${item.timestamp}</span>
                    </div>
                    <div class="flex items-center justify-between text-xs text-white/70">
                        <span>${item.method}</span>
                        <span>${(item.confidence * 100).toFixed(1)}%</span>
                    </div>
                </div>
            `).join('');
        }
        
        function clearRecognitionHistory() {
            recognitionHistory = [];
            updateHistoryDisplay();
        }
        
        function playAudio() {
            if (currentAudioUrl) {
                resultAudio.play();
            }
        }
        
        function copyToClipboard() {
            const text = recognizedSign.textContent;
            if (text && text !== '-') {
                navigator.clipboard.writeText(text).then(() => {
                    const originalText = copyResult.textContent;
                    copyResult.textContent = '‚úÖ Copied!';
                    setTimeout(() => {
                        copyResult.textContent = originalText;
                    }, 2000);
                });
            }
        }
        
        function updateStatus(type, message) {
            statusIndicator.className = `status-indicator status-${type}`;
            statusText.textContent = message;
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
        
        console.log('üìπ Live Sign Recognition interface initialized');
    </script>
</body>
</html>